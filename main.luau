--# selene: allow(undefined_global)
print("PIZZAHUB LOADING...")

-- ===============================
-- CONFIGURATION MODULES
-- ===============================

-- Config: Settings
getgenv().AutoMine = false
getgenv().SelectTools = ""
getgenv().SelectRocks = ""
getgenv().TweenSpeed = 50

-- Config: Rocks
local RocksTable = {}
local RocksSet = {}

local function InitRocks()
    table.clear(RocksTable)
    table.clear(RocksSet)

    for _, island in pairs(workspace.Rocks:GetChildren()) do
        for _, rocks in pairs(island:GetChildren()) do
            for _, rock in pairs(rocks:GetChildren()) do
                if rock:IsA("Model") and rock:FindFirstChild("Hitbox") then
                    if not RocksSet[rock.Name] then
                        RocksSet[rock.Name] = true
                        table.insert(RocksTable, rock.Name)
                    end
                end
            end
        end
    end
end

InitRocks()

-- ===============================
-- LIBRARY MODULES
-- ===============================

-- Lib: Services
local Services = {
    TweenService = game:GetService("TweenService"),
    RunService = game:GetService("RunService"),
    Workspace = game:GetService("Workspace"),
    Players = game:GetService("Players"),
}

Services.LocalPlayer = Services.Players.LocalPlayer
Services.Character = Services.LocalPlayer.Character
Services.RootPart = Services.Character.HumanoidRootPart

-- Lib: Movement
local Movement = {}

function Movement.Tween(TargetCF, Speed)
    local pos = TargetCF.Position
    local dis = (pos - Services.RootPart.Position).Magnitude
    local tween = Services.TweenService:Create(
        Services.RootPart,
        TweenInfo.new(dis / Speed, Enum.EasingStyle.Linear),
        { CFrame = TargetCF }
    )
    tween:Play()
end

-- Lib: Noclip
local Noclip = {}

function Noclip.Enable()
	for _, v in pairs(Services.Character:GetDescendants()) do
		if v:IsA("BasePart") then
			v.CanCollide = false
		end
	end
end

-- Lib: Taiteen
local Taiteen = {}

local part = workspace:FindFirstChild("TaiTeen")

if not part then
	part = Instance.new("Part")
	part.Name = "TaiTeen"
	part.Parent = workspace
	part.Anchored = true
	part.Transparency = 1
	part.Size = Vector3.new(30, 0.5, 30)
end

function Taiteen.Update()
	if Services.RootPart then
		part.CFrame = Services.RootPart.CFrame * CFrame.new(0, -3, 0)
	end
end

-- Lib: Tool
local Tool = {}
local ToolsTable = {}

function Tool.Availble()
	table.clear(ToolsTable)

	local toolsFrame = game:GetService("Players").LocalPlayer.PlayerGui
		.Menu.Frame.Frame.Menus.Tools.Frame

	for _, slot in pairs(toolsFrame:GetChildren()) do
        if slot.Name == "EmptySlot" then continue end
		if slot:IsA("Frame") then
			local viewport = slot:FindFirstChild("ViewportFrame")
			if viewport then
				for _, obj in pairs(viewport:GetChildren()) do
					if obj:IsA("Model") then
						table.insert(ToolsTable, obj.Name)
					end
				end
			end
		end
	end
end

Tool.Availble()

-- Script generated by SimpleSpy - credits to exx#9394

function getNil(name,class) for _,v in pairs(getnilinstances())do if v.ClassName==class and v.Name==name then return v;end end end

local args = {
    [1] = {
        ["Runes"] = {},
        ["Name"] = "Stone Pickaxe"
    }
}

game:GetService("ReplicatedStorage").Shared.Packages.Knit.Services.CharacterService.RF.EquipItem:InvokeServer(unpack(args))

function Tool.Select(args)
	game:GetService("ReplicatedStorage").Shared.Packages.Knit.Services.CharacterService.RF.EquipItem
		:InvokeServer(unpack(args))
end


function Tool.Pickaxe()
	game:GetService("ReplicatedStorage").Shared.Packages.Knit.Services.ToolService.RF.ToolActivated
		:InvokeServer("Pickaxe")
end

function Tool.Weapon()
	game:GetService("ReplicatedStorage").Shared.Packages.Knit.Services.ToolService.RF.ToolActivated
		:InvokeServer("Weapon")
end

-- ===============================
-- FEATURE MODULES
-- ===============================

-- Features: AutoMine
local AutoMine = {}

function AutoMine.Start()
	task.spawn(function()
		while task.wait() do
			workspace.Camera.CameraSubject = Services.RootPart
			if not getgenv().AutoMine then continue end

			for _, island in pairs(workspace.Rocks:GetChildren()) do
				for _, rocks in pairs(island:GetChildren()) do
					if not getgenv().AutoMine then break end

					for _, rock in pairs(rocks:GetChildren()) do
						if rock:IsA("Model") and rock:FindFirstChild("Hitbox") then
							if #getgenv().SelectRocks > 0 and not table.find(getgenv().SelectRocks, rock.Name) then
								continue
							end

							local Hitbox = rock.Hitbox

							repeat
								task.wait()

								if not getgenv().AutoMine then break end
								if not rock.Parent then break end

								local HP = tonumber(rock:GetAttribute("Health"))
								if not HP or HP <= 0 then break end

								Movement.Tween(Hitbox.CFrame * CFrame.new(0, -4, 0), getgenv().TweenSpeed)

								Tool.Pickaxe()
								Noclip.Enable()
								Taiteen.Update()

								if (Hitbox.Position - Services.RootPart.Position).Magnitude <= 6 then
									workspace.Camera.CameraSubject = Hitbox
								else
									workspace.Camera.CameraSubject = Services.RootPart
								end

							until not rock.Parent or HP <= 0 or not getgenv().AutoMine
						end
					end
				end
			end
		end
	end)
end

-- ===============================
-- UI MODULES
-- ===============================

-- UI: Menu
local WindUI

do
    local ok, result = pcall(function()
        return require("./src/Init")
    end)
    
    if ok then
        WindUI = result
    else 
        WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()
    end
end

local Window = WindUI:CreateWindow({
	Title = "PIZZAHUB THE FORGE",
	Icon = "door-open",
	Author = "TEST",
	OpenButton = {
		Title = "Open Ai",
		Icon = "monitor",
		CornerRadius = UDim.new(0, 16),
		StrokeThickness = 2,
		Color = ColorSequence.new(Color3.fromHex("FF0F7B"), Color3.fromHex("F89B29")),
		OnlyMobile = false,
		Enabled = true,
		Draggable = true,
	},
})

Window:SetToggleKey(Enum.KeyCode.H)

local Tab = Window:Tab({
	Title = "Main",
	Icon = "bird",
})
Tab:Select()

Tab:Dropdown({
	Title = "Select Tools",
	Values = ToolsTable,
	Multi = false,
	AllowNone = true,
	Callback = function(v)
		getgenv().SelectTools = v
	end,
})

Tab:Dropdown({
	Title = "Select Rocks",
	Values = RocksTable,
	Multi = true,
	AllowNone = true,
	Callback = function(v)
		getgenv().SelectRocks = v
	end,
})

Tab:Toggle({
	Title = "Auto Mine",
	Value = false,
	Callback = function(v)
		getgenv().AutoMine = v
		if v then
			AutoMine.Start()
		end
	end,
})

Tab:Slider({
	Title = "TweenSpeed",
	Step = 1,
	Value = {
		Min = 1,
		Max = 50,
		Default = getgenv().TweenSpeed,
	},
	Callback = function(v)
		getgenv().TweenSpeed = v
	end,
})

print("PIZZAHUB LOADED...")
